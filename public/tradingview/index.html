<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TradingView 图表</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <script type="text/javascript" src="charting_library/charting_library.js"></script>
    <script type="text/javascript" src="./env.js"></script>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        background-color: #0d1117;
        overflow: hidden;
      }

      #tv_chart_container {
        width: 100vw;
        height: 100vh;
        background-color: #0d1117;
      }
    </style>
  </head>
  <body>
    <div id="tv_chart_container"></div>
    <script type="module">
      import TradingViewDatafeed from './datafeed.js';
      import SaveLoadAdapter from './saveLoadAdapter.js';
      import { createSDGIndicator } from './indicators/sdg.js';

      function resolveBackendUrl() {
        const override = window.__BACKEND_URL__;
        if (typeof override === 'string' && override.trim().length) {
          return override.trim().replace(/\/$/, '');
        }

        const envBaseUrl = import.meta?.env?.VITE_API_BASE_URL;
        if (typeof envBaseUrl === 'string' && envBaseUrl.trim().length) {
          return envBaseUrl.trim().replace(/\/$/, '');
        }

        const { hostname, port, protocol, origin } = window.location;
        const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';

        // 本地开发：前端常跑在 8080，后端跑在 3001
        if (isLocalhost && port && port !== '3001') {
          return `${protocol}//${hostname}:3001`;
        }

        return origin;
      }

      const BACKEND_URL = resolveBackendUrl();
      const datafeed = new TradingViewDatafeed(BACKEND_URL);
      const saveLoadAdapter = new SaveLoadAdapter(BACKEND_URL, {
        timeout: 15000,
        maxRetries: 3,
        debug: false
      });

      const DEFAULT_SYMBOL = 'SSE:000001';
      const DEFAULT_INTERVAL = '1D';

      async function initializeWidget() {
        let hasSavedCharts = false;
        let initialSettings = {};

        // 并行执行初始化请求，避免串行等待
        const [chartsResult, settingsResult] = await Promise.allSettled([
          saveLoadAdapter.getAllCharts(),
          fetch(`${BACKEND_URL}/api/settings`).then(res => res.ok ? res.json() : null),
        ]);

        if (chartsResult.status === 'fulfilled') {
          const chartCount = Array.isArray(chartsResult.value) ? chartsResult.value.length : 0;
          hasSavedCharts = chartCount > 0;
        } else {
          console.warn('[ChartStorage] 检查保存图表失败，使用默认配置:', chartsResult.reason?.message);
        }

        if (settingsResult.status === 'fulfilled' && settingsResult.value?.settings) {
          initialSettings = settingsResult.value.settings;
        } else if (settingsResult.status === 'rejected') {
          console.warn('[Settings] 加载用户设置失败，将使用默认设置:', settingsResult.reason?.message);
        }

        const widgetOptions = {
          debug: true,
          interval: DEFAULT_INTERVAL,
          container: 'tv_chart_container',
          datafeed: datafeed,
          library_path: 'charting_library/',
          locale: 'zh',
          timezone: 'Asia/Shanghai',
          fullscreen: true,
          autosize: false,
          theme: 'light',

          save_load_adapter: saveLoadAdapter,
          auto_save_delay: 1,
          load_last_chart: hasSavedCharts,
          settings_adapter: {
            initialSettings,
            setValue: async (key, value) => {
              try {
                await fetch(`${BACKEND_URL}/api/settings`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ key, value }),
                });
              } catch (error) {
                console.warn('[Settings] 保存设置失败:', error.message);
              }
            },
            removeValue: async (key) => {
              try {
                await fetch(`${BACKEND_URL}/api/settings/${encodeURIComponent(key)}`, {
                  method: 'DELETE',
                });
              } catch (error) {
                console.warn('[Settings] 删除设置失败:', error.message);
              }
            },
          },

          // 自定义指标
          custom_indicators_getter: function(PineJS) {
            return Promise.resolve([createSDGIndicator(PineJS)]);
          },

          enabled_features: [
            'pre_post_market_sessions',
            'seconds_resolution',
            'disable_resolution_rebuild',
            'dom_widget',
            'study_templates',
            'chart_template_storage',
            'saveload_separate_drawings_storage',
            'show_symbol_logos',
            'show_exchange_logos',
          ],
          disabled_features: [
            'trading_account_manager',
            // 关闭账户管理器（Trading Panel）默认打开行为
            'open_account_manager',
          ],
          studies_overrides: {},
          overrides: {
          },
          widgetbar: {
            watchlist: true,
            details: true,
            news: true,
            watchlist_settings: {
              default_symbols: [
                'SSE:000001',
              ],
            },
          },

          // 自定义新闻数据提供商
          news_provider: function(symbol, callback) {
            // 解析 symbol 获取完整格式的 Promise
            // TradingView 可能传入 ticker (如 SSE:000001) 或 description (如 上证综合指数)
            const resolveSymbol = symbol.includes(':')
              ? Promise.resolve(symbol)
              : fetch(`${BACKEND_URL}/api/datafeed/search?query=${encodeURIComponent(symbol)}&limit=1`)
                  .then(res => res.ok ? res.json() : Promise.reject(new Error('search failed')))
                  .then(results => {
                    if (Array.isArray(results) && results.length > 0 && results[0].ticker) {
                      return results[0].ticker;
                    }
                    throw new Error('no match found');
                  })
                  .catch(() => symbol);

            resolveSymbol
              .then(fullSymbol => {
                console.log('[News] 获取新闻:', symbol, '->', fullSymbol);
                return fetch(`${BACKEND_URL}/api/news/list?symbol=${encodeURIComponent(fullSymbol)}&limit=30`);
              })
              .then(res => {
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
              })
              .then(data => {
                callback({
                  title: `${symbol} News`,
                  newsItems: (data.items || []).map(item => {
                    const source = item.source || item.provider?.name || 'Unknown';
                    const relatedCount = item.relatedSymbols?.length || 0;
                    // 格式化 UTC+8 时间
                    const date = new Date(item.published * 1000);
                    const utc8Time = new Date(date.getTime() + 8 * 60 * 60 * 1000);
                    const month = utc8Time.getUTCMonth() + 1;
                    const day = utc8Time.getUTCDate();
                    const hours = String(utc8Time.getUTCHours()).padStart(2, '0');
                    const minutes = String(utc8Time.getUTCMinutes()).padStart(2, '0');
                    const timeStr = `${month}月${day}日 ${hours}:${minutes}`;
                    // shortDescription 显示 UTC+8 时间和来源
                    const shortDesc = relatedCount > 0
                      ? `${timeStr} · ${source} · 相关 ${relatedCount} 个标的`
                      : `${timeStr} · ${source}`;
                    return {
                      title: item.title,
                      // TradingView 需要毫秒时间戳，后端返回的是秒级时间戳，需要乘以 1000
                      published: item.published * 1000,
                      source: source,
                      shortDescription: shortDesc,
                      link: item.link || (item.storyPath
                        ? `https://www.tradingview.com${item.storyPath}`
                        : undefined),
                    };
                  }),
                });
              })
              .catch(err => {
                console.error('[News] 新闻加载失败:', err);
                callback({ title: 'News', newsItems: [] });
              });
          },
        };

        if (!hasSavedCharts) {
          widgetOptions.symbol = DEFAULT_SYMBOL;
        }

        if (!window.TradingView || !window.TradingView.widget) {
          console.error('TradingView 图表库尚未加载');
          return;
        }

        const widget = new TradingView.widget(widgetOptions);
        widget.onChartReady(() => {
          console.info('TradingView Widget 已准备就绪');

          widget.subscribe('onAutoSaveNeeded', function handleAutoSave() {
            widget.saveChartToServer(
              () => console.info('[ChartStorage] 自动保存成功'),
              () => console.warn('[ChartStorage] 自动保存失败'),
              { defaultChartName: '自动保存' }
            );
          });
        });
      }

      initializeWidget();
    </script>
  </body>
</html>
